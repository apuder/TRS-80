<!DOCTYPE html>
<html manifest="cache.manifest">
<head>
<title>TRS 80</title>
<meta http-equiv="Cache-Control"
	content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script
	src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>

<script type="text/javascript">
	var TYPE_START_SESSION      = '1';
	var TYPE_END_SESSION        = '2';
	var TYPE_SEND_SCREEN_BUFFER = '3';
	var TYPE_SET_EXPANDED_MODE  = '4';
	var TYPE_SEND_CONFIGURATION = '5';
	
	window.setScreenBuffer = function(data) {
		var preContent = "";
		for (var i = 0; i < data.length; ++i) {
			if (i % 64 == 0 && i > 0) {
				preContent += "\n";
			}
			preContent += data[i];
		}
		$('#screen').text(preContent);
	}

	window.addEventListener('load', function() {
		window.console.log('# Loading #');
	    // window.mediaManager = new cast.receiver.MediaManager(mediaElement);	    
	    window.castReceiverManager = cast.receiver.CastReceiverManager.getInstance();
 	    var customMessageBus =
	    	window.castReceiverManager.getCastMessageBus(
	    			'urn:x-cast:org.puder.trs80');
	    window.screenWrapper = document.getElementById('screenWrapper');

		customMessageBus.onMessage = function(event) {
			var message = event.data;
			console.log('Message received: ' + message);
			if (message[1] != ':') {
				console.error('Invalid message: ' + message);
				return;
			}
			var messageType = message[0];
			var payload = message.substring(2);
			
			if (messageType == TYPE_START_SESSION) {
			} else if (messageType == TYPE_END_SESSION) {
			} else if (messageType == TYPE_SEND_SCREEN_BUFFER) {
				setScreenBuffer(payload);
			} else if (messageType == TYPE_SET_EXPANDED_MODE) {
			} else if (messageType == TYPE_SEND_CONFIGURATION) {
			} else {
				console.error('Unsupported message type: ' + message);
				return;
			}
		};
	    window.castReceiverManager.start();


    var m3toUnicode =[
	// Special characters, highly ad-hoc.
	  0x20,   0xa3,   0x7c,   0xe9,   0xdc,   0xc5,   0xac,   0xf6,
	  0xd8,   0xf9,   0xf1,   0x60, 0x0101, 0xe00d,   0xc4,   0xc3,
	  0xd1,   0xd6,   0xd8,   0xd5,   0xdf,   0xfc,   0xf5,   0xe6,
	  0xe4,   0xe0, 0x0227, 0xe01b,   0xc9,   0xc6,   0xc7, 0x02dc,

	// ASCII range.  Identity map of 20 .. 7e with special case for 7f.
	0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27,
	0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f,
	0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
	0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f,
	0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47,
	0x48, 0x49, 0x4a, 0x4b, 0x4c, 0x4d, 0x4e, 0x4f,
	0x50, 0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57,
	0x58, 0x59, 0x5a, 0x5b, 0x5c, 0x5d, 0x5e, 0x5f,
	0x60, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67,
	0x68, 0x69, 0x6a, 0x6b, 0x6c, 0x6d, 0x6e, 0x6f,
	0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77,
	0x78, 0x79, 0x7a, 0x7b, 0x7c, 0x7d, 0x7e, 0xb1,

	// Graphics characters.  Trivial map of 80 .. BF to E080 .. E0BF.
	0xe080, 0xe081, 0xe082, 0xe083, 0xe084, 0xe085, 0xe086, 0xe087,
	0xe088, 0xe089, 0xe08a, 0xe08b, 0xe08c, 0xe08d, 0xe08e, 0xe08f,
	0xe090, 0xe091, 0xe092, 0xe093, 0xe094, 0xe095, 0xe096, 0xe097,
	0xe098, 0xe099, 0xe09a, 0xe09b, 0xe09c, 0xe09d, 0xe09e, 0xe09f,
	0xe0a0, 0xe0a1, 0xe0a2, 0xe0a3, 0xe0a4, 0xe0a5, 0xe0a6, 0xe0a7,
	0xe0a8, 0xe0a9, 0xe0aa, 0xe0ab, 0xe0ac, 0xe0ad, 0xe0ae, 0xe0af,
	0xe0b0, 0xe0b1, 0xe0b2, 0xe0b3, 0xe0b4, 0xe0b5, 0xe0b6, 0xe0b7,
	0xe0b8, 0xe0b9, 0xe0ba, 0xe0bb, 0xe0bc, 0xe0bd, 0xe0be, 0xe0bf,

	// Special characters.  Mostly ad-hoc, but contiguous stretch for
	// the lowercase Greek letters.
	0x2660, 0x2665, 0x2666, 0x2663, 0x263a, 0x2639, 0x2264, 0x2265,
	0x03b1, 0x03b2, 0x03b3, 0x03b4, 0x03b5, 0x03b6, 0x03b7, 0x03b8,
	0x03b9, 0x03ba, 0x03bc, 0x03bd, 0x03be, 0x03bf, 0x03c0, 0x03c1,
	0x03c2, 0x03c3, 0x03c4, 0x03c5, 0x03c6, 0x03c7, 0x03c8, 0x03c9,
	0x2126, 0x221a,   0xf7, 0x2211, 0x2248, 0x2206, 0x2307, 0x2260,
	0x2301, 0xe0e9, 0x237e, 0x221e, 0x2713,   0xa7, 0x2318,   0xa9,
	  0xa4,   0xb6,   0xa2,   0xae, 0xe0f4, 0xe0f5, 0xe0f6, 0x211e,
	0x2105, 0x2642, 0x2640, 0xe0fb, 0xe0fc, 0xe0fd, 0xe0fe, 0x2302,

	// Halfwidth Katakana.  Trivial map of C1 .. FF to FF61 .. FF9F
	//   with special case for C0 (Yen sign).
	  0xa5, 0xff61, 0xff62, 0xff63, 0xff64, 0xff65, 0xff66, 0xff67,
	0xff68, 0xff69, 0xff6a, 0xff6b, 0xff6c, 0xff6d, 0xff6e, 0xff6f,
	0xff70, 0xff71, 0xff72, 0xff73, 0xff74, 0xff75, 0xff76, 0xff77,
	0xff78, 0xff79, 0xff7a, 0xff7b, 0xff7c, 0xff7d, 0xff7e, 0xff7f,
	0xff80, 0xff81, 0xff82, 0xff83, 0xff84, 0xff85, 0xff86, 0xff87,
	0xff88, 0xff89, 0xff8a, 0xff8b, 0xff8c, 0xff8d, 0xff8e, 0xff8f,
	0xff90, 0xff91, 0xff92, 0xff93, 0xff94, 0xff95, 0xff96, 0xff97,
	0xff98, 0xff99, 0xff9a, 0xff9b, 0xff9c, 0xff9d, 0xff9e, 0xff9f
];
     var i=0;
     var content = '';
     for (i=0;i<320;++i){
	    content += '&#' + m3toUnicode[i];
	    if ((i % 64) == 0) {
	    	content += "<br />";
    	}
     }
      // $('#screen').html(content);
 	});

</script>
<style>

@font-face {
	font-family: 'TreasureMIII64C';
	src: url('AnotherMansTreasureMIII64C.ttf');
}
@font-face {
	font-family: 'TreasureMIII32C';
	src: url('AnotherMansTreasureMIII32C.ttf');
}

html {
	background-color: black;
	height:100%;
}

body {
	text-align:center;
	background:#221;
	height:100%;
	border:0;
	margin:0;
}

#screen {
  color:#3c3;
  text-align: center;
  font-family:'TreasureMIII64C';
  font-size:36px;
  display:inline-block;
  background:black;
  border:0;
}


</style>
</head>
<body>
	<div id="screenWrapper"><pre id="screen"></pre></div>
</body>
</html>